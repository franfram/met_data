---
title: "ECMWF"
author: "franfram"
date: "2021-09-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## 

This script downloads, wrangles and plots data from the European Centre for Medium-Range Weather Forecasts (ECMWF) using Python's CDS API <https://pypi.org/project/cdsapi/>.

Install the CDS API and configure its key <https://cds.climate.copernicus.eu/api-how-to>

We used the ERA5-land reanalysis dataset <https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land?tab=overview>

[Dataset details:]{.ul}

-   File format: GRIB.

-   Horizontal resolution: 0.1° x 0.1°.

-   Temporal resolution: Hourly.

-   Horizontal and temporal resolution: Global, january 1981 to present.

-   Variables:

    -   2m temperature (K): Temperature of air at 2m above the surface of land, sea or in-land waters. 2m temperature is calculated by interpolating between the lowest model level and the Earth's surface, taking account of the atmospheric conditions.

    -   2m dewpoint temperature (K): Temperature to which the air, at 2 metres above the surface of the Earth, would have to be cooled for saturation to occur.It is a measure of the humidity of the air. Combined with temperature and pressure, it can be used to calculate the relative humidity. 2m dew point temperature is calculated by interpolating between the lowest model level and the Earth's surface, taking account of the atmospheric conditions.

    -   Total precipitation: Accumulated liquid and frozen water, including rain and snow, that falls to the Earth's surface. It is the sum of large-scale precipitation (that precipitation which is generated by large-scale weather patterns, such as troughs and cold fronts) and convective precipitation (generated by convection which occurs when air at lower levels in the atmosphere is warmer and less dense than the air above, so it rises). Precipitation variables do not include fog, dew or the precipitation that evaporates in the atmosphere before it lands at the surface of the Earth. This variable is accumulated from the beginning of the forecast time to the end of the forecast step. The units of precipitation are depth in metres. It is the depth the water would have if it were spread evenly over the grid box. Care should be taken when comparing model variables with observations, because observations are often local to a particular point in space and time, rather than representing averages over a model grid box and model time step.

### Data retrieval

```{r}
options(warn = -1)

```

```{python eval=FALSE, include=FALSE, echo=TRUE}

import cdsapi
from pyprojroot import here 
 
if __name__ == '__main__':
 
    c = cdsapi.Client()
 
    COORDS = {
            "GENERAL_PICO":[-35.696,	-63.758], 
            "MINISTRO_PISTARINI":[-34.822, -58.536],
            "MARCOS_JUAREZ":[-32.684, -62.158],
            "MAR DEL PLATA AERO":[-37.933, -57.583],
            "PILAR OBSERVATORIO":[-31.667, -63.883],
            "JUNIN":[-34.546, -60.931],
            "ROSARIO": [-32.904, -60.785],
            "GENERAL_PICO_2":[-35.697,	-63.759] 
            }
            
    VARIABLES = [
            '2m_temperature',
            'total_precipitation',
            '2m_dewpoint_temperature'
    ]
 
 
    YEARS = '2017'
 
    MONTHS = [
      '01',
      '02', 
      '03', 
      '04', 
    ]
    DAYS = ['%02d'%(mn) for mn in range(1,32)]
 

    for station in COORDS: 
      station_point_coord = COORDS[station]*2 # c.retrieve() requires an area (4 values: North, West, South, East). With this trick, we can specify lat lon values instead.
      c.retrieve( # CDS API
          'reanalysis-era5-land', # Dataset
          {
              'variable': VARIABLES,
              'format': 'grib',
              'time': [
            '00:00', '01:00', '02:00',
            '03:00', '04:00', '05:00',
            '06:00', '07:00', '08:00',
            '09:00', '10:00', '11:00',
            '12:00', '13:00', '14:00',
            '15:00', '16:00', '17:00',
            '18:00', '19:00', '20:00',
            '21:00', '22:00', '23:00',
        ], 
              'day': DAYS,
              'month': MONTHS,
              'year': YEARS,
              'area': station_point_coord,
              },
          here('./data/' + f'metdata_era5_{station}.grib'))          




```

### Import grib data as N-D labeled arrays, then save as .csv

```{python echo=TRUE, eval=FALSE}
import xarray as xr
import pandas as pd
from pyprojroot import here

COORDS = {
        "GENERAL_PICO":[-35.696,	-63.758], 
        "MINISTRO_PISTARINI":[-34.822, -58.536],
        "MARCOS_JUAREZ":[-32.684, -62.158],
        "MAR DEL PLATA AERO":[-37.933, -57.583],
        "PILAR OBSERVATORIO":[-31.667, -63.883],
        "JUNIN":[-34.546, -60.931],
        "ROSARIO": [-32.904, -60.785],
        "GENERAL_PICO_2":[-35.697,	-63.759] 
        }

metdata = {}
for station in COORDS:
  # read grib file and convert to data frame
  metdata = xr.open_dataset(
      here('./data/' + f'metdata_era5_{station}.grib'),
      engine = 'cfgrib'
      ).to_dataframe().rename_axis(['time', 'step', 'lat', 'lon']).reset_index()
  # add column for station name        
  metdata['station'] = pd.Series([f'{station}' for x in range(len(metdata.index))])
  # save as csv
  metdata.to_csv(here(str('./data/' + f'metdata_era5_{station}.csv')))   
    


```

### Import .csv files with R and then wrangle

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(here)


list_csv <- dir(path = here("data"), pattern = "*.csv") 
path <- here("data", list_csv)

metdata_2017_raw <- path %>% 
  lapply(read.csv) %>% 
  bind_rows() %>% 
  mutate(
    'valid_time' = ymd_hms(valid_time),
    'Date' = date(valid_time),
    'Time' = format(valid_time, format = "%H:%M:%S"),
    'Day' = day(valid_time)
  ) %>% 
  mutate( # Kelvin to C°
    't2m' = t2m - 273.15,
    'd2m' = d2m - 273.15
  ) %>% 
  filter(year(Date) == '2017') %>% 
  select('station', 'lat', 'lon', 'Date', 'Day', 'Time', 't2m', 'tp', 'd2m') %>% 
  ungroup()



# Compute daily means 
metdata_2017_daily <- metdata_2017_raw %>%  
  group_by(station, lat, lon, Date, Day) %>% 
  summarise( # compute daily means
    't2m_dmean' = mean(t2m), 
    'tp_dmean' = mean(tp), 
    'd2m_dmean' = mean(d2m)
  ) %>% 
  select('station', 'lat', 'lon', 'Date', 't2m_dmean', 'tp_dmean', 'd2m_dmean') %>% 
  ungroup()

# Compute weekly means from daily means    
metdata_2017_weekly <- metdata_2017_daily %>% 
  group_by(station, week = week(Date)) %>% 
  mutate(
    't2m_wmean' = mean(t2m_dmean), 
    'tp_wmean' = mean(tp_dmean), 
    'd2m_wmean' = mean(d2m_dmean)
  ) %>% 
  ungroup()




```

### Plot

#### Temperature

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(ggplot2)

(
plot_temp <- metdata_2017_weekly %>%
  ggplot() +
  geom_line(aes(x = week, y = t2m_wmean, color = station)) +
  labs(y = "ECMWF 2m Temperature")
)





```

#### Dewpoint

```{r echo=TRUE, message=FALSE, warning=FALSE}

(
plot_temp <- metdata_2017_weekly %>%
  ggplot() +
  geom_line(aes(x = week, y = d2m_wmean, color = station)) +
  labs(y = "ECMWF 2m Dewpoint")
)
```

#### Total precipitation

```{r echo=TRUE, message=FALSE, warning=FALSE}

(
plot_temp <- metdata_2017_weekly %>%
  ggplot() +
  geom_line(aes(x = week, y = tp_wmean, color = station)) +
  labs(y = "ECMWF Total Precipitation")
)

```
